---
- name: Install and setup git
  hosts: all
  become: no

  vars:
    apt_packages:
      - git
      - git-lfs
    # HOME: "{{ ansible_env.HOME }}"
    HOME: /home/pi
    priv: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      64386366353739623562373263343337613561366562323765646230313534333761303133333263
      3262666466376465663932383763383334333039373561350a396365343764373533653164626365
      33363037393036343063336164316633376435373664636261366164373731636130663136333333
      6130363762356330370a386165653137636235316133323130353233656266623438646166356336
      66303864326234386232343536363765333636653636636562653766633632306634353930373631
      63366463643164333763346234623139336362303135306563343837613662383635656232373466
      66643431393437376638376265366334663537346436633838643837636364376332393439623538
      33613331633161393730396231373133376531663463366333656137333231376666346631646561
      63303361346637303836333634313435386466666564376464366666376161373537356338336232
      61333230336264343466333137313935656235303139343162653331393663366539626139356666
      62333564316332393337333732636431616234313361636636303464393232333933343664353434
      65356531376531386461326263343836336436653939396231336662613165653830636637643236
      37666631393237643634663330383765656261316630353461396462393266373936393562353832
      63393131643365386631346264613966633361383865303534643930376261356532663634306434
      66656339326361363534316430303834363030363530386631623731663436303539613866303639
      34643532363764336232316130303231633864316437643966653536393663636266366366396531
      32383163353835336163326462666333303935613262643536613630383161336532366438396364
      34653933646534363832656138666238333864326664353233663064666438333134356562633665
      66633066313031383737393532363464626532366237353834306164353363653038653133306239
      62663933363931646638623164636132633664333631366163653566393661633130613737663531
      39363530393030616631363639366232393730303065666630663534323937336165333063663266
      63643236303031643931303363353030663266616135623964386331613539353861623766383963
      63303438613566616633383365376431336662306238396464316366366362663261393963653361
      66663036366161643938623037663335623566396266313932333335633935366333643938346130
      6534
    pub: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35646562306633633532316466316334613663303262306263643037366366666434616135353761
      3139333435303030643332323332626130343337393639360a633863386231333663366231303663
      64396363323734643264343639386238656165323365346530323539656133336366363839623831
      6437663861656134620a333065343732363139363662353565386534306365373035356439313232
      33386237363166303566343035323332663833626136623939643364306662636661383932653032
      38656336613436323163366630656139353331616338396461376532353238356661373232393533
      61363235303932663035393037643764646565636231373863643137643136616130353138316435
      33396633623861656564633730383839323534373235633238363662373433343166306266356437
      30373739643865373763613864313535343138313466663934666363303636653237

  tasks:
    - name: Install packages
      apt:
        name: "{{ apt_packages }}"
        update_cache: no
      become: yes
      register: apt_status
      until: apt_status is success
      delay: 6
      retries: 10

    - name: git user
      git_config:
        name: "{{ item.name }}"
        scope: global
        value: "{{ item.value }}"
      with_items:
        - {name: user.name, value: walchko}
        - {name: user.email, value: walchko@users.noreply.github.com}
        - {name: push.default, value: simple}

    - name: Template public key
      template:
        src: ../templates/pub_key.j2
        dest: "{{ HOME }}/.ssh/id_ed25519.pub"
        owner: pi
        group: pi
        mode: '0644'

    - name: Create a github directory
      file:
        path: "{{ HOME }}/github"
        state: directory
        mode: '0755'

    - name: Template for private key
      template:
        src: ../templates/priv_key.j2
        dest: "{{ HOME }}/.ssh/id_ed25519"
        owner: pi
        group: pi
        mode: '0600'

    - name: Template ssh conf
      template:
        src: ../templates/ssh_config.j2
        dest: "{{ HOME }}/.ssh/config"
        owner: pi
        group: pi
        mode: '0644'

    - name: Clone some of my repo's
      git:
        repo: "{{ item.repo }}"
        dest: "{{ HOME }}/github/{{ item.folder }}"
      with_items:
        - {folder: dotfiles, repo: git@github.com:walchko/dotfiles.git}
      become: no
      register: apt_status
      until: apt_status is success
      delay: 6
      retries: 10
